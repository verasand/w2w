<!DOCTYPE html>
<html lang="es">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prototipo de W2W</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- NUEVA LIBRER√çA: html2canvas para tomar "snapshots" -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58BHEqVRK
    XySYNzQBUQQ/g2gnsKEzHQTACHcTXjUeMyPDqFqqmbclnyFIIgIijGidBFHIw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .leaflet-container { background: #eee; }
        .shadow-top { box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.1), 0 -2px 4px -2px rgb(0 0 0 / 0.1); }
        #sideMenu { transition: transform 0.3s ease-in-out; }
        .menu-open { transform: translateX(0) !important; }
        .user-marker { filter: hue-rotate(170deg) saturate(1.5); }
        
        /* Estilos para el spinner de carga */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script defer src="/__/firebase/12.6.0/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/12.6.0/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/12.6.0/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/12.6.0/firebase-storage-compat.js"></script>

    <script defer src="/__/firebase/init.js?useEmulator=true"></script>
</head>
<body class="bg-gray-100">

    <div class="max-w-md mx-auto h-svh flex flex-col bg-white overflow-hidden shadow-2xl">

        <!-- 1. Encabezado de la App -->
        <header class="flex justify-between items-center p-4 bg-white shadow-md z-20">
            <button id="menuButton" class="p-2 rounded-full hover:bg-gray-100 focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
            </button>
            <h1 class="text-xl font-bold text-gray-800">W2W: Where to Weed?</h1>
            <div class="flex items-center justify-end gap-2">

                 <!-- Bot√≥n de cambiar rol (SIEMPRE visible) -->
    <button id="roleToggleButton"
            class="p-2 rounded-full hover:bg-gray-100 focus:outline-none"
            title="Cambiar rol">
        <!-- Icono sencillo de usuario con doble flecha -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-700" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M5.5 20a4.5 4.5 0 0 1 9 0M10 11a3 3 0 1 0-3-3 3 3 0 0 0 3 3Zm6-4h3m0 0-1.5-1.5M19 7l-1.5 1.5M18 13h-3m0 0 1.5-1.5M15 13l1.5 1.5"/>
        </svg>
    </button>
                <button id="loginButton" class="text-sm bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700">Inicia Sesi√≥n</button>
                <div id="userInfo" class="hidden items-center gap-2">
                    <img id="userPhoto" src="" alt="Foto" class="h-8 w-8 rounded-full" />
                    <span id="userName" class="text-sm font-medium text-gray-800"></span>
                    <button id="logoutButton" class="ml-2 text-xs text-gray-500 hover:text-gray-700">Salir</button>
                </div>
            </div>
        </header>

<main class="flex-grow relative z-0">
            
            <div id="map" class="absolute inset-0"></div>

            <div id="legend" class="absolute bottom-4 left-4 [z-index:1000] bg-white bg-opacity-80 backdrop-blur-sm p-3 rounded-lg shadow-lg">
                <h4 class="font-bold text-sm mb-2 text-gray-800">√Åreas restringidas</h4>
                <div class="space-y-2">
                    
                    <div class="flex items-center gap-2">
                        <img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png" class="h-6 w-auto -ml-1">
                        <span class="text-xs text-gray-700 font-medium">Escuela</span>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png" class="h-6 w-auto -ml-1">
                        <span class="text-xs text-gray-700 font-medium">Parque</span>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png" class="h-6 w-auto -ml-1">
                        <span class="text-xs text-gray-700 font-medium">Centro Deportivo</span>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <img src="https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png" class="h-6 w-auto -ml-1">
                        <span class="text-xs text-gray-700 font-medium">Otro</span>
                    </div>

                </div>
            </div>
            </main>

        <!-- 3. Panel de Acci√≥n (Footer) -->
        <footer class="p-4 bg-white shadow-top z-10">
            <div class="flex flex-col gap-3">
                <div id="statusResult" class="hidden text-center p-3 rounded-lg">
                    <p id="statusText" class="font-bold text-white text-lg"></p>
                    <p id="distanceText" class="text-sm text-white opacity-90"></p>
                </div>
                
                <button id="checkButton" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-200 flex items-center justify-center gap-2">
                    <span id="checkButtonText">¬øPuedo hacer la actividad X aqu√≠?</span>
                    <div id="checkSpinner" class="spinner hidden"></div>
                </button>
                
                <!-- NUEVO BOT√ìN DE EVIDENCIA (INICIALMENTE OCULTO) -->
                <button id="snapshotButton" class="w-full bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 transition duration-200 hidden flex items-center justify-center gap-2">
                    <span id="snapshotButtonText">Crear Evidencia</span>
                    <div id="snapshotSpinner" class="spinner hidden"></div>
                </button>
            </div>
        </footer>

        <!-- 4. Men√∫ Lateral (Oculto por defecto) -->
        <div id="sideMenu" class="absolute inset-y-0 left-0 w-72 bg-white shadow-xl z-30 transform -translate-x-full">
            <div class="flex flex-col h-full">
                <div class="flex justify-between items-center p-4 border-b">
                    <h2 class="text-lg font-semibold">Zonas Restringidas</h2>
                    <button id="closeMenuButton" class="p-2 rounded-full hover:bg-gray-100 focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <ul id="placesList" class="flex-grow overflow-y-auto p-2">
                    <!-- Los lugares se insertar√°n aqu√≠ -->
                </ul>
            </div>
        </div>
        
        <div id="menuOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden"></div>

        <!-- 5. NUEVO MODAL DE EVIDENCIA (INICIALMENTE OCULTO) -->
        <div id="snapshotModal" class="fixed inset-0 bg-black bg-opacity-75 z-40 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-2xl max-w-sm w-full overflow-hidden">
                <!-- Contenido de la evidencia (esto es lo que se descargar√°) -->
                <div id="evidenceCard" class="bg-white">
                    <div class="p-4 border-b">
                        <h3 class="text-xl font-bold text-gray-900">Evidencia de Ubicaci√≥n</h3>
                    </div>
                    <!-- Aqu√≠ ir√° la "foto" del mapa -->
                    <div id="snapshotImageContainer" class="bg-gray-200">
                        <img id="snapshotImage" src="" alt="Snapshot del Mapa" class="w-full h-auto" />
                    </div>
                    <!-- Aqu√≠ ir√° la informaci√≥n de texto -->
                    <div id="snapshotInfo" class="p-4 text-sm text-gray-700 space-y-2">
                        <!-- La informaci√≥n se inyectar√° aqu√≠ -->
                    </div>
                </div>
                
                <!-- Botones de Acci√≥n del Modal -->
                <div class="p-4 bg-gray-50 border-t flex gap-3">
                    <button id="downloadSnapshotButton" class="w-full bg-blue-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-blue-700 transition duration-150">Descargar</button>
                    <button id="closeModalButton" class="w-full bg-gray-200 text-gray-700 font-semibold py-2 px-3 rounded-lg hover:bg-gray-300 transition duration-150">Cerrar</button>
                </div>
            </div>
        </div>

    </div>


<!-- MODAL DE SELECCI√ìN DE ROL -->
<div id="roleModal" class="fixed inset-0 bg-black bg-opacity-60 z-40 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full overflow-hidden">
        <!-- Header -->
        <div class="flex items-center justify-between px-4 py-3 border-b">
            <h3 class="text-lg font-semibold text-gray-900">Selecciona tu rol</h3>
            <button id="closeRoleModalButton"
                    class="p-1 rounded-full hover:bg-gray-100 focus:outline-none"
                    title="Cerrar">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Body -->
        <div class="px-4 pt-4 pb-2 space-y-3">
            <p class="text-sm text-gray-600">
                Este rol se usar√° para personalizar la informaci√≥n que ves en la app.
                Puedes cambiarlo desde el icono junto al login.
            </p>

            <div class="space-y-2">
                <button id="roleCivilButton"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition flex items-center justify-center gap-2">
                    <span>üôç‚Äç‚ôÇÔ∏è Soy Civil</span>
                </button>

                <button id="rolePoliceButton"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition flex items-center justify-center gap-2">
                    <span>üëÆ Soy Agente de Polic√≠a</span>
                </button>
            </div>
        </div>

        <!-- Footer -->
        <div class="px-4 pb-4 pt-2 text-xs text-gray-500">
            <p>Tu selecci√≥n se guardar√° en este dispositivo. Si borras la cach√© del navegador, la app te volver√° a preguntar.</p>
        </div>
    </div>
</div>




    <script>
        document.addEventListener('DOMContentLoaded', async () => {
                // 1. CREA LAS VARIABLES DE FIREBASE
            const auth = firebase.auth();
            const db = firebase.firestore();
            const storage = firebase.storage();
            // --- 2. CONFIGURACI√ìN INICIAL ---
            const initialCoords = [3.0108578687016765, -76.48504798984096];
            let restrictedAreas = [];

            // --- Elementos del DOM ---
            const mapElement = document.getElementById('map');
            const checkButton = document.getElementById('checkButton');
            const checkButtonText = document.getElementById('checkButtonText');
            const checkSpinner = document.getElementById('checkSpinner');
            const statusResult = document.getElementById('statusResult');
            const statusText = document.getElementById('statusText');
            const distanceText = document.getElementById('distanceText');
            const menuButton = document.getElementById('menuButton');
            const closeMenuButton = document.getElementById('closeMenuButton');
            const sideMenu = document.getElementById('sideMenu');
            const menuOverlay = document.getElementById('menuOverlay');
            const placesList = document.getElementById('placesList');

            // --- Nuevos elementos para Evidencia ---
            const snapshotButton = document.getElementById('snapshotButton');
            const snapshotButtonText = document.getElementById('snapshotButtonText');
            const snapshotSpinner = document.getElementById('snapshotSpinner');
            const snapshotModal = document.getElementById('snapshotModal');
            const closeModalButton = document.getElementById('closeModalButton');
            const downloadSnapshotButton = document.getElementById('downloadSnapshotButton');
            const evidenceCard = document.getElementById('evidenceCard');
            const snapshotImage = document.getElementById('snapshotImage');
            const snapshotInfo = document.getElementById('snapshotInfo');


            // --- NUEVOS ELEMENTOS PARA ROL ---
            const roleToggleButton = document.getElementById('roleToggleButton');
            const roleModal = document.getElementById('roleModal');
            const closeRoleModalButton = document.getElementById('closeRoleModalButton');
            const roleCivilButton = document.getElementById('roleCivilButton');
            const rolePoliceButton = document.getElementById('rolePoliceButton');
            const ROLE_KEY = 'userRole'; // localStorage key

            let userMarker = null;
            let map = null;
            let lastCheckData = null; // Variable para guardar los datos de la √∫ltima revisi√≥n


            // --- L√ìGICA DE SELECCI√ìN DE ROL ---

function openRoleModal() {
    roleModal.classList.remove('hidden');
}

function closeRoleModal() {
    roleModal.classList.add('hidden');
}

function setUserRole(role) {
    try {
        localStorage.setItem(ROLE_KEY, role);
        console.log('Rol guardado:', role);
    } catch (e) {
        console.error('Error guardando rol en localStorage:', e);
    }
}

// Icono persistente junto al login: abrir modal para cambiar rol
roleToggleButton.addEventListener('click', () => {
    openRoleModal();
});

// Cerrar modal (bot√≥n X)
closeRoleModalButton.addEventListener('click', () => {
    closeRoleModal();
});

// Seleccionar "Soy Civil"
roleCivilButton.addEventListener('click', () => {
    setUserRole('civilian');
    closeRoleModal();
    // Aqu√≠ luego podr√°s adaptar la l√≥gica de la app seg√∫n el rol
});

// Seleccionar "Soy Agente de Polic√≠a"
rolePoliceButton.addEventListener('click', () => {
    setUserRole('police');
    closeRoleModal();
    // Aqu√≠ luego podr√°s adaptar la l√≥gica de la app seg√∫n el rol
});





            // --- 2. L√ìGICA DE PER√çMETRO DIN√ÅMICO ---
// --- 2. L√ìGICA DE PER√çMETRO DIN√ÅMICO (Basada en Decreto Municipal) ---
            function getPerimeter(type, city) {
                
                // El par√°metro 'type' ya no se usa, pero lo mantenemos
                // para que no falle el c√≥digo que la llama.

                if (city === 'Cali') {
                    return 200; // 200 metros para Cali
                }
                
                if (city === 'Santander de Quilichao') {
                    return 60;  // 60 metros para Santander
                }

                // Un valor por defecto si la ciudad no es ninguna de las dos
                // o si el campo 'city' est√° vac√≠o en el JSON.
                return 50; 
            }
// --- 3. NUEVA FUNCI√ìN: Obtener √≠cono por tipo ---
            function getIconForArea(type) {
                // Convertir a min√∫sculas para seguridad
                const lowerCaseType = type ? type.toLowerCase() : '';

                // URL base de los marcadores
                const baseUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/';
                
                let iconUrl = baseUrl + 'marker-icon-2x-grey.png'; // √çcono gris por defecto

                if (lowerCaseType === 'school') {
                    iconUrl = baseUrl + 'marker-icon-2x-red.png'; // Rojo para escuelas
                } else if (lowerCaseType === 'park') {
                    iconUrl = baseUrl + 'marker-icon-2x-green.png'; // Verde para parques
                } else if (lowerCaseType === 'sport center') {
                    iconUrl = baseUrl + 'marker-icon-2x-blue.png'; // Azul para deportes
                }
                // (Puedes a√±adir m√°s 'else if' para otros tipos)

                const shadowUrl = baseUrl + 'marker-shadow.png';

                // Devolver un objeto L.icon de Leaflet
                return L.icon({
                    iconUrl: iconUrl,
                    shadowUrl: shadowUrl,
                    iconSize: [25, 41],   // Tama√±o est√°ndar de Leaflet
                    iconAnchor: [12, 41],  // Punto de anclaje
                    popupAnchor: [1, -34],  // D√≥nde sale el popup
                    shadowSize: [41, 41]
                });
            }



async function seedDatabase() {
    try {
        // 1. Revisa si la base de datos YA tiene datos
        const checkSnapshot = await db.collection("restricted_areas").limit(1).get();
        if (!checkSnapshot.empty) {
            console.log("La base de datos ya tiene datos. No se necesita 'seed'.");
            return; // Salir de la funci√≥n, ya est√° poblada
        }

        console.log("Base de datos vac√≠a. Poblando con datos de data.json...");

        // 2. Carga el archivo data.json
        const response = await fetch('./data.json');
        const locations = await response.json();

        // 3. Itera y agrega cada locaci√≥n
        let count = 0;
        for (const location of locations) {
            // 'await' es opcional aqu√≠, pero es m√°s seguro para el emulador
            await db.collection("restricted_areas").add(location);
            count++;
        }

        console.log(`¬°'Seed' completado! Se agregaron ${count} locaciones.`);

    } catch (error) {
        console.error("Error durante el 'seed' de la base de datos:", error);
    }
}



            // --- 3. INICIALIZACI√ìN DEL MAPA ---
// MAPA AS√çNCRONO
async function initMap() {
    try {
        map = L.map(mapElement).setView(initialCoords, 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            crossOrigin: 'anonymous'
        }).addTo(map);

        // ¬°AQU√ç EST√Å EL CAMBIO!
        // Espera a que las zonas se carguen de la DB antes de continuar
        await fetchAndDrawAreas(); 

        // A√±adir control personalizado para centrar
        try { createCenterControl(); } catch (err) { /* si algo falla, no detener la app */ }

    } catch (e) {
        console.error("Error al inicializar el mapa:", e);
        mapElement.innerHTML = "<div class='p-4 text-center text-red-500'>Error al cargar el mapa.</div>";
    }
}
            
            // --- 4. DIBUJAR ZONAS Y POBLAR MEN√ö ---
            // NUEVA FUNCI√ìN AS√çNCRONA PARA CARGAR DATOS
async function fetchAndDrawAreas() {
    console.log("Buscando √°reas en Firestore...");
    try {
        // 1. Llama a la base de datos (db)
        const snapshot = await db.collection("restricted_areas").get();

        if (snapshot.empty) {
            console.warn("No se encontraron √°reas en la base de datos.");
            return;
        }

        placesList.innerHTML = ''; // Limpiar el men√∫ lateral

        // 2. Itera sobre cada "documento" encontrado
        snapshot.docs.forEach(doc => {
            const area = doc.data();

            // 3. Llena el array global (para que 'checkProximity' funcione)
            restrictedAreas.push(area); 

            // 4. Dibuja en el mapa (la l√≥gica de la vieja funci√≥n)
            const radius = getPerimeter(area.type, area.city);

            L.circle([area.lat, area.lng], {
                color: 'red', fillColor: '#f03', fillOpacity: 0.3, radius: radius
            }).addTo(map);

            // 4b. Obtener el √≠cono personalizado basado en el tipo
const customIcon = getIconForArea(area.type);

// 4c. Crear el marcador USANDO el nuevo √≠cono
L.marker([area.lat, area.lng], { icon: customIcon }) // <-- ¬°AQU√ç EST√Å EL CAMBIO!
    .addTo(map)
    .bindPopup(`<b>${area.name}</b><br>${area.city}<br>Radio: ${radius}m`);

            // 5. Rellena el men√∫ lateral
            const li = document.createElement('li');
            li.innerHTML = `
                <a href="#" class="block p-3 rounded-md hover:bg-gray-100 transition duration-150">
                    <p class="font-medium text-gray-800">${area.name}</p>
                    <p class="text-sm text-gray-500">${area.city} (${area.type})</p>
                    <p class="text-sm text-blue-600 font-medium">Per√≠metro: ${radius}m</p>
                </a>`;
            li.addEventListener('click', (e) => {
                e.preventDefault();
                map.setView([area.lat, area.lng], 16);
                closeMenu();
            });
            placesList.appendChild(li);
        });

        console.log("√Åreas cargadas y dibujadas:", restrictedAreas);

    } catch (error) {
        console.error("Error al cargar √°reas desde Firestore:", error);
        alert("Error al cargar las zonas. Revisa la consola (F12).");
    }
}

            // --- 5. MANEJO DEL MEN√ö LATERAL ---
            function openMenu() {
                sideMenu.classList.add('menu-open');
                menuOverlay.classList.remove('hidden');
            }
            function closeMenu() {
                sideMenu.classList.remove('menu-open');
                menuOverlay.classList.add('hidden');
            }
            menuButton.addEventListener('click', openMenu);
            closeMenuButton.addEventListener('click', closeMenu);
            menuOverlay.addEventListener('click', closeMenu);

            // --- 6. L√ìGICA DE GEOLOCALIZACI√ìN ---
            checkButton.addEventListener('click', () => {
                if (!navigator.geolocation) {
                    showStatus("Geolocalizaci√≥n no soportada.", "bg-yellow-500", "");
                    return;
                }
                checkButton.disabled = true;
                checkButtonText.textContent = "Obteniendo ubicaci√≥n...";
                checkSpinner.classList.remove('hidden');
                snapshotButton.classList.add('hidden'); // Ocultar bot√≥n de evidencia
                
                navigator.geolocation.getCurrentPosition(onLocationSuccess, onLocationError, { enableHighAccuracy: true });
            });

            function onLocationSuccess(position) {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;
                const userLocation = L.latLng(userLat, userLng);

                updateAndSortSideMenu(userLocation);

                if (userMarker) {
                    userMarker.setLatLng(userLocation);
                } else {
                    userMarker = L.marker(userLocation, {
                        icon: L.icon({
                            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
                            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                            shadowSize: [41, 41], className: 'user-marker'
                        })
                    }).addTo(map);
                }

                userMarker.bindPopup("<b>¬°Est√°s aqu√≠!</b>").openPopup();
                map.setView(userLocation, 16);
                
                // Forzar a Leaflet a redibujar antes del snapshot (importante)
                map.invalidateSize(); 
                
                checkProximity(userLocation);
            }

            function onLocationError(error) {
                let message = "Error al obtener la ubicaci√≥n.";
                if (error.code === error.PERMISSION_DENIED) message = "Permiso de ubicaci√≥n denegado.";
                showStatus(message, "bg-red-500", "");
                resetButton();
            }

            function checkProximity(userLocation) {
                let isProhibited = false;
                let closestDistance = Infinity;
                let statusMessage = "";

                restrictedAreas.forEach(area => {
                    const areaLocation = L.latLng(area.lat, area.lng);
                    const distance = userLocation.distanceTo(areaLocation);
                    if (distance < closestDistance) closestDistance = distance;
                    const radius = getPerimeter(area.type, area.city);
                    if (distance <= radius) isProhibited = true;
                });
                
                if (isProhibited) {
                    statusMessage = "Actividad Prohibida";
                    showStatus(statusMessage, "bg-red-500", `Est√°s dentro de un √°rea restringida. Distancia: ${closestDistance.toFixed(0)}m`);
                } else {
                    statusMessage = "Actividad Permitida";
                    showStatus(statusMessage, "bg-green-500", `Zona restringida m√°s cercana: ${closestDistance.toFixed(0)} metros`);
                }
                
                // Guardar datos para la evidencia
                lastCheckData = {
                    status: statusMessage,
                    statusClass: isProhibited ? 'text-red-600' : 'text-green-600',
                    location: userLocation,
                    timestamp: new Date(),
                    distance: closestDistance.toFixed(0) + 'm'
                };
                
                resetButton();
                snapshotButton.classList.remove('hidden'); // Mostrar bot√≥n de evidencia
            }



            // --- 9. NUEVA FUNCI√ìN: ACTUALIZAR Y ORDENAR MEN√ö LATERAL ---
            function updateAndSortSideMenu(userLocation) {
                if (!restrictedAreas || restrictedAreas.length === 0) return;

                // 1. Itera por todas las √°reas y calcula su distancia desde el usuario
                restrictedAreas.forEach(area => {
                    const areaLocation = L.latLng(area.lat, area.lng);
                    // Guarda la distancia calculada en el propio objeto
                    area.currentDistance = userLocation.distanceTo(areaLocation);
                });

                // 2. Ordena el array 'restrictedAreas' de menor a mayor distancia
                restrictedAreas.sort((a, b) => a.currentDistance - b.currentDistance);

                // 3. Limpia el contenido actual del men√∫ lateral
                placesList.innerHTML = '';

                // 4. Vuelve a construir la lista, ahora ordenada y con la nueva info
                restrictedAreas.forEach(area => {
                    const li = document.createElement('li');
                    
                    // Formatea la distancia para mostrarla (ej: "123m")
                    const distanceDisplay = area.currentDistance.toFixed(0) + 'm';

                    // ¬°AQU√ç EST√Å EL CAMBIO!
                    // Se reemplaza "Per√≠metro" por "Distancia"
                    li.innerHTML = `
                        <a href="#" class="block p-3 rounded-md hover:bg-gray-100 transition duration-150">
                            <p class="font-medium text-gray-800">${area.name}</p>
                            <p class="text-sm text-gray-500">${area.city} (${area.type})</p>
                            <p class="text-sm text-blue-600 font-medium">Distancia: ${distanceDisplay}</p>
                        </a>`;
                    
                    // Se vuelve a a√±adir el listener para que al hacer clic se centre en el mapa
                    li.addEventListener('click', (e) => {
                        e.preventDefault();
                        map.setView([area.lat, area.lng], 16);
                        closeMenu();
                    });
                    
                    placesList.appendChild(li);
                });
            }
            
            // --- Helper: crear o mover marcador de usuario ---
            function createOrMoveUserMarker(latlng) {
                if (!map) return;
                if (userMarker) {
                    userMarker.setLatLng(latlng);
                } else {
                    userMarker = L.marker(latlng, {
                        icon: L.icon({
                            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
                            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                            shadowSize: [41, 41], className: 'user-marker'
                        })
                    }).addTo(map);
                }
                userMarker.bindPopup("<b>¬°Est√°s aqu√≠!</b>");
            }

            // --- Control personalizado: bot√≥n "centrar en mi ubicaci√≥n" ---
            function createCenterControl() {
                if (!map || !L || !L.Control) return;
                const CenterControl = L.Control.extend({
                    options: { position: 'topleft' },
                    onAdd: function () {
                        const container = L.DomUtil.create('div', 'leaflet-bar');
                        const btn = L.DomUtil.create('a', '', container);
                        btn.href = '#';
                        btn.title = 'Centrar en mi ubicaci√≥n';
btn.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="black">
    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
</svg>
    `;

    // --- üëá AQU√ç EST√Å LA SOLUCI√ìN üëá ---
                        // A√±adimos estilos flex para centrar el SVG dentro del bot√≥n <a>
                        btn.style.display = 'flex';         // NUEVO: Activa Flexbox
                        btn.style.alignItems = 'center';    // NUEVO: Centra verticalmente
                        btn.style.justifyContent = 'center';// NUEVO: Centra horizontalmente
                        // --- FIN DE LA SOLUCI√ìN ---

                        L.DomEvent.disableClickPropagation(container);
                        L.DomEvent.on(btn, 'click', L.DomEvent.stop)
                                 .on(btn, 'click', () => {
                                    btn.classList.add('opacity-50');
                                    btn.style.pointerEvents = 'none';
                                    if (!navigator.geolocation) {
                                        alert('Geolocalizaci√≥n no soportada en este navegador.');
                                        btn.classList.remove('opacity-50');
                                        btn.style.pointerEvents = '';
                                        return;
                                    }
                                    navigator.geolocation.getCurrentPosition((pos) => {
                                        const userLoc = L.latLng(pos.coords.latitude, pos.coords.longitude);
                                        createOrMoveUserMarker(userLoc);
                                        map.setView(userLoc, 16);
                                        map.invalidateSize();
                                        btn.classList.remove('opacity-50');
                                        btn.style.pointerEvents = '';
                                    }, (err) => {
                                        alert('Error al obtener la ubicaci√≥n.');
                                        btn.classList.remove('opacity-50');
                                        btn.style.pointerEvents = '';
                                    }, { enableHighAccuracy: true });
                                 });

                        return container;
                    }
                });
                map.addControl(new CenterControl());
            }
            
            // --- 7. FUNCIONES AUXILIARES DE UI ---
            function showStatus(message, bgColor, distanceMsg) {
                statusText.textContent = message;
                distanceText.textContent = distanceMsg;
                statusResult.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500');
                statusResult.classList.add(bgColor);
                statusResult.classList.remove('hidden');
            }
            
            function resetButton() {
                checkButton.disabled = false;
                checkButtonText.textContent = "¬øPuedo hacer la actividad X aqu√≠?";
                checkSpinner.classList.add('hidden');
            }
            
            // --- 8. NUEVA L√ìGICA DE EVIDENCIA (SNAPSHOT) ---
            
            // Al hacer clic en "Crear Evidencia"
            snapshotButton.addEventListener('click', async () => {
                if (!lastCheckData) return;

                snapshotButton.disabled = true;
                snapshotButtonText.textContent = "Generando...";
                snapshotSpinner.classList.remove('hidden');

                try {
                    // 1. Tomar la "foto" del mapa
                    //    Usamos {useCORS: true} para intentar capturar los tiles del mapa.
                    const canvas = await html2canvas(mapElement, { 
                        useCORS: true,
                        logging: false // Desactivar logs de html2canvas en consola
                    });
                    const imageDataUrl = canvas.toDataURL('image/png');
                    
                    // 2. Poner la "foto" en el modal
                    snapshotImage.src = imageDataUrl;
                    
                    // 3. Formatear la fecha y hora
                    const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short' };
                    const formattedDate = lastCheckData.timestamp.toLocaleString('es-CO', options);

                    // 4. Poner la informaci√≥n de texto en el modal
                    snapshotInfo.innerHTML = `
                        <p><strong>Estado:</strong> <span class="font-bold ${lastCheckData.statusClass}">${lastCheckData.status}</span></p>
                        <p><strong>Fecha y Hora:</strong> ${formattedDate}</p>
                        <p><strong>Coordenadas:</strong> ${lastCheckData.location.lat.toFixed(6)}, ${lastCheckData.location.lng.toFixed(6)}</p>
                        <p><strong>Distancia m√°s cercana:</strong> ${lastCheckData.distance}</p>
                    `;
                    
                    // 5. Mostrar el modal
                    snapshotModal.classList.remove('hidden');

                } catch (err) {
                    console.error("Error al generar snapshot:", err);
                    alert("Error al generar la evidencia. Int√©ntalo de nuevo.");
                } finally {
                    snapshotButton.disabled = false;
                    snapshotButtonText.textContent = "Crear Evidencia";
                    snapshotSpinner.classList.add('hidden');
                }
            });

            // Al hacer clic en "Cerrar" en el modal
            closeModalButton.addEventListener('click', () => {
                snapshotModal.classList.add('hidden');
            });
            
            // Al hacer clic en "Descargar"
            downloadSnapshotButton.addEventListener('click', async () => {
                try {
                    // Tomamos una "foto" del *contenido del modal* (la tarjeta de evidencia)
                    const canvas = await html2canvas(evidenceCard, { logging: false });
                    const imageDataUrl = canvas.toDataURL('image/png');
                    
                    // Crear un enlace temporal para la descarga
                    const link = document.createElement('a');
                    link.href = imageDataUrl;
                    link.download = `evidencia_geo_${lastCheckData.timestamp.toISOString()}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                } catch (err) {
                    console.error("Error al descargar snapshot:", err);
                    alert("Error al descargar la evidencia.");
                }
            });

            // --- AUTENTICACI√ìN: Login con Google (Firebase Auth) ---
            // Elementos del UI de auth
            const loginButton = document.getElementById('loginButton');
            const userInfo = document.getElementById('userInfo');
            const userPhoto = document.getElementById('userPhoto');
            const userName = document.getElementById('userName');
            const logoutButton = document.getElementById('logoutButton');

            // Mostrar datos de usuario en UI
            function showUser(user) {
                if (!user) return showLogin();
                loginButton.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userPhoto.src = user.photoURL || '';
                userName.textContent = user.displayName || user.email || 'Usuario';
            }

            function showLogin() {
                loginButton.classList.remove('hidden');
                userInfo.classList.add('hidden');
                userPhoto.src = '';
                userName.textContent = '';
            }

            // Bot√≥n de login: abrir popup de Google
            loginButton.addEventListener('click', async () => {
                loginButton.disabled = true;
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    await auth.signInWithPopup(provider);
                    // onAuthStateChanged manejar√° la UI
                } catch (err) {
                    console.error('Error en signInWithPopup:', err);
                    alert('Error al iniciar sesi√≥n. Revisa la consola.');
                } finally {
                    loginButton.disabled = false;
                }
            });

            // Bot√≥n de logout
            logoutButton.addEventListener('click', async () => {
                try {
                    await auth.signOut();
                } catch (err) {
                    console.error('Error al cerrar sesi√≥n:', err);
                    alert('Error al cerrar sesi√≥n. Revisa la consola.');
                }
            });

            // Observador de estado de autenticaci√≥n
            auth.onAuthStateChanged((user) => {
                if (user) showUser(user);
                else showLogin();
            });


            // --- CHEQUEAR ROL AL INICIAR LA APP ---
// Si no hay rol guardado, mostramos el modal una sola vez.
const savedRole = localStorage.getItem(ROLE_KEY);
if (!savedRole) {
    openRoleModal();
} else {
    console.log('Rol previamente guardado:', savedRole);
}

            // --- INICIAR LA APP ---
            await seedDatabase();
            await initMap();
        });
    </script>
</body>
</html>